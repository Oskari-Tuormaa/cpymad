language: python

# See: https://docs.travis-ci.com/user/languages/python/
python:
  - "2.7"
  - "3.3"
  - "3.4"
  - "3.5"
  - "3.6"
# - "3.7"   in `jobs`, see below!

sudo: required
dist: trusty

env:
  global:
    # GITHUB_TOKEN:
    - secure: "fdvPaSzbpf47Qb/2zDg/eHAS0bBFaAkWFxyxmhHQOkD0PlVxwi1Fh0Sq3dUZVwQgmmYj+hF6cFpqkFQJQe3zFqw9k14Ccr4dk69yjPNbQA1+yg0ARFntyqtM2DUN86brMcZG3ZM6V2HFuzKn9cQUvtjCQSKS26HybEnCG4vXz24="
    # PYPI_PASSWORD:
    - secure: "A/bn3uZV6tNCCOMspsjo6A38s4WyOAK8ScuMOtlSl/pbm68RirCakDT/QT/UTlTjUGfFRZGOtc3Mktb/7P52JokTYSGWfWTv9a7IC5vv7MzJTgI40LU23K+zaTesZH6OYhvHoiQ+u74o5JkZQT9h0nc1G0jYo4wn82RxiIO4veo="

before_install:
  - lsb_release -a
  - env | sort

  # Install MAD-X from PPA (see https://github.com/hibtc/madx-debian):
  - sudo add-apt-repository -y ppa:coldfix/madx
  - sudo apt-get -qq update
  - sudo apt-get install -y libmadx-dev

install:
  # Check that the source distribution can be used for installation:
  - pip install cython
  - python setup.py sdist
  - pip uninstall cython -y
  - X11=0 BLAS=1 LAPACK=1 pip install $(ls ./dist/*.tar.gz | sort -rV | head -n1)

  # docutils is required for `setup.py check -r`:
  - pip install flake8 docutils
  - pip install coverage coveralls

script:
  - python setup.py check -rsm
  - flake8

  # Need to remove cpymad folder otherwise it will be imported, but we want
  # to check the version installed from the source distribution:
  - rm -r cpymad
  - coverage run --source=cpymad -a test/test_util.py -v
  - coverage run --source=cpymad -a test/test_madx.py -v

after_success:
  - base=`python -c 'import os,cpymad; print(os.path.dirname(cpymad.__file__))'`/..
  - mv .git .coverage $base
  - cd $base
  - coveralls

cache:
  pip: true


# Each stage is executed only if all previous stages have succeeded:
stages:
  - test        # the default (global) stage
  - deploy      # see below

jobs:
  include:
    # Ubuntu 16.04 (Xenial Xerus) required for py3.7:
    - stage: test
      python: "3.7"
      dist: xenial

    - stage: deploy
      name: Upload release tarballs
      python: "3.6"
      services:
        - docker
      before_install: skip
      install:
        - pip install docker-compose
      script:
        - docker build -t wheelbuilder utils/manylinux
        # at the time of writing, mounting /io/cpymad as readonly volume
        # (the `:ro` option) causes container init error when executed on
        # travis (not on my local machine though), so we use `:rw` instead:
        - docker run --init --name artifacts
            -v `pwd`:/io/cpymad:rw
            --cap-drop=all
            wheelbuilder
        - mkdir -p artifacts
        - docker cp artifacts:/io/wheels ./artifacts/
        - mkdir -p dist
        - cp artifacts/wheels/*.whl dist/
      after_success: true   # don't "skip"! it makes travis skip "deploy:" too!
      deploy:
      # Upload artifacts to github
      - provider: pages
        local-dir: ./artifacts
        skip_cleanup: true
        on:
          all_branches: true
        repo: hibtc/cpymad-artifacts
        target-branch: master
        github-token: $GITHUB_TOKEN
      # Upload manylinux wheels to test.pypi.org (only on branch test-release)
      - provider: pypi
        skip_cleanup: true
        server: https://test.pypi.org/legacy/
        on:
          branch: test-release
        user: hibtc-deploy
        password: $PYPI_PASSWORD
      # Upload manylinux wheels (only when pushing tags)
      - provider: pypi
        skip_cleanup: true
        on:
          tags: true
        user: hibtc-deploy
        password: $PYPI_PASSWORD

    - stage: deploy
      name: GitHub Pages
      python: "3.6"
      install:
        - pip install cython sphinx sphinx_rtd_theme
        - X11=0 BLAS=1 LAPACK=1 python setup.py develop
      script:
        - cd doc
        - make html
      after_success: true   # don't "skip"! it makes travis skip "deploy:" too!
      deploy:
        provider: pages
        local-dir: doc/_build/html
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        on:
          branch: master
